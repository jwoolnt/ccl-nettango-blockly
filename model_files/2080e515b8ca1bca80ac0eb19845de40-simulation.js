import{D as e,l as t,b as o,T as s}from"../776758b4.chunk.js";import{c as r,a as n,b as i}from"../0c519d2c.chunk.js";import{f as l,N as a}from"../ff16522a.chunk.js";import{W as c}from"../4de76fd9.chunk.js";import"../82e39951.chunk.js";import{A as d}from"../269286ff.chunk.js";import{n as u}from"../cbb093d8.chunk.js";import{S as g}from"../705881a2.chunk.js";import{i as p}from"../9e84f2a3.chunk.js";import"../4cf393e8.chunk.js";import"../be63bf84.chunk.js";import"../28b3ec8f.chunk.js";import"../69daaf60.chunk.js";import"../d5edbd81.chunk.js";import"../f47357e2.chunk.js";var h,m,w,f;w=function(e,t,o,s){e.postMessage({type:"nlw-query-response",queries:t,sourceInfo:o,results:s},"*")},m=function(e,t){var o;switch(t.type){case"globals":return{type:"globals-result",globals:e.getGlobals(t.variableFilters)};case"reporter":return(o=e.runReporter(t.code)).type="reporter-result",o;case"widgets":return{type:"widgets-result",widgets:e.getWidgets()};case"info":return{type:"info-result",info:e.getInfo()};case"code":return{type:"code-result",code:e.getCode()};case"nlogo-file":return{type:"nlogo-file-result",nlogo:e.getNlogo()};case"metadata":return{type:"metadata-result",title:e.getModelTitle(),source:e.getSource(),speed:e.getSpeed(),ticks:e.getTicks(),currentPlot:e.getCurrentPlot(),perspective:e.getCurrentPerspective()};case"view":return{type:"view-result",base64:e.getView()};default:throw new Error(`Unknown query: ${t}`)}},h=function(e){var t,o;o=null,t=function(t){var s;return s=e(),null!=o&&o.session===s||(o=r(s,globalThis.workspace)),m(o,t)},window.addEventListener("message",(function(e){var o;null!=e.data&&"nlw-query"===e.data.type&&(o=e.data.queries.map(t),w(e.source,e.data.queries,e.data.sourceInfo,o))}))},f=class{constructor(e,t){this.storage=e,this.storagePrefix=null!=t&&""!==t.trim()?`${t}:`:"",this._nlogoSource=null,this._data=new c(this.storage,this.storagePrefix),this.session=null,this.reverted=null}getNlogoSource(){return this._nlogoSource}setNlogoSource(e){return this._data.update(e),this._nlogoSource=e}getWipKey(){return`${this.storagePrefix}${this.getNlogoSource().getWipKey()}`}setSession(e){var t;this.session=e,null!=this.reverted?this.session.widgetController.ractive.set("workInProgressState","enabled-with-reversion"):(t=this.getWipKey(),this.notifyOfWorkInProgress(this.storage.hasKey(t)))}getCurrentNlogo(){return this.session.getNlogo()}getModelTitle(){return this.session.modelTitle()}notifyOfWorkInProgress(e){var t;t=e?"enabled-with-wip":"enabled-and-empty",this.session.widgetController.ractive.set("workInProgressState",t)}getWip(){var e,t;return t=this.getWipKey(),null!=(e=this.storage.get(t))?e:null}revertWip(){var e;e=this.getWipKey(),this.reverted=this.storage.get(e),this.storage.remove(e)}undoRevert(){var e;e=this.getWipKey(),this.storage.set(e,this.reverted),this.reverted=null}_storeWipInfo(e,t,o){this._data.store(e,t,o),this.notifyOfWorkInProgress(!0)}_removeWipInfo(e){this.storage.remove(e),this.notifyOfWorkInProgress(!1)}_setWip(e){var t,o,s;this.reverted=null,s=this.getWipKey(),o=this.getModelTitle(),e===(t=this.getNlogoSource()).nlogo&&`${o}.nlogo`===t.fileName?this._removeWipInfo(s):(t.setModelTitle(o),this._storeWipInfo(s,e,o))}_maybeSetWip(){var e,t;try{(t=this.getCurrentNlogo()).success&&this._setWip(t.result)}catch(t){e=t,console.log("Unable to set work in progress, `getCurrentNlogo()` or `_setWip()` failed.",e)}}_updateForFileExport(t,o){var s;s=new e(t,o),["disk","new"].includes(this.getNlogoSource().type)&&(this.setNlogoSource(s),this._setWip(o))}_filterCompileErrors(e){["recompile"].includes(e.source)&&this._maybeSetWip()}"recompile-complete"(){return this._maybeSetWip()}"compiler-error"(e,t){return this._filterCompileErrors(t)}"new-widget-finalized"(){return this._maybeSetWip()}"widget-updated"(){return this._maybeSetWip()}"widget-deleted"(){return this._maybeSetWip()}"widget-moved"(){return this._maybeSetWip()}"info-updated"(){return this._maybeSetWip()}"title-changed"(){return this._maybeSetWip()}"nlogo-exported"(e,{fileName:t,nlogo:o}){return this._updateForFileExport(t,o)}};try{var b=document.getElementById("loading-overlay"),y=b,v=document.querySelector("#netlogo-model-container"),k=document.querySelector("#nlogo-code");const P=new URLSearchParams(window.location.search),j=Array.from(P.keys());if(1===j.length){const O=j[0];O.startsWith("http")&&""===P.get(O)&&(P.delete(O),P.set("url",O),window.location.search=P.toString())}if("1"===P.get("errCode"))throw new Error("Throwing an error as the `errCode` query parameter was set to `1`.  This is only meant for testing and should not be used otherwise.");var T;try{T=window.localStorage}catch(D){T=l()}const E=p(T),M=new g;M.applyStorage(E),M.applyQueryParams(P);const R=[],[q,x]=(()=>{if(M.workInProgress.enabled){const e=new a("netLogoWebWip",T),t=new f(e,M.workInProgress.storageTag),o=e=>{t.setNlogoSource(e);const o=t.getWip();return null!==o?(e.setModelTitle(o.title),o.nlogo):e.nlogo};return R.push(t),[t,o]}return[null,null]})();var W=function(e){return null!=e&&""!=e?"NetLogo Web: "+e:"NetLogo Web"};globalThis.session=null;var S=function(e){globalThis.session=e,M.workInProgress.enabled&&q.setSession(globalThis.session),M.title&&globalThis.session.widgetController.ractive.set("modelTitle",M.title),globalThis.session.widgetController.ractive.set("speed",M.speed),globalThis.session.widgetController.ractive.set("isVertical",M.useVerticalLayout),document.title=W(globalThis.session.modelTitle()),y=v,globalThis.session.startLoop(),$.setWidgetController(globalThis.session.widgetController)};const L=k.textContent.length>0,U=parent!==window,$=new d(document.getElementById("alert-container"),L),F=document.getElementById("alert-dialog");function C(e){"success"===e.type?S(e.session):("compile-recoverable"===e.source?S(e.session):(y=F,b.style.display="none"),K("compiler-error",e.source,e.modelSourceType,e.modelCode,e.errors))}if(R.push($),M.events.enableDebug){const V=n(t);R.push(V)}if(U&&M.events.enableIframeRelay){const z=i(t,M.events.iframeRelayEvents,M.events.iframeRelayEventsTag);R.push(z)}const K=o(t,R);if(U){h((()=>globalThis.session))}var N=function(e,t,o,r){$.hide(),globalThis.session&&globalThis.session.teardown(),y=b;const n=s.createSource(t,o,e);s.fromNlogo(n,v,M.locale,r,x,C,[],R)};const B=function(e){const t=new URL(e);if("https:"===t.protocol||"http:"===window.location.protocol)return!0;const o=window.location,s=t.hostname===o.hostname,r="ccl.northwestern.edu"===t.hostname,n=s&&window.debugMode?"9443":"443",i=`https://${t.hostname}:${n}${t.pathname}`;if(!s&&!r&&U)return $.reportProtocolError(t,i),y=F,b.style.display="none",!1;var l="";P.has("url")?(P.set("url",i),l=P.toString()):l=i;const a=`https://${o.host}${o.pathname}?${l}`;return s||r?(window.location.href=a,!1):($.reportProtocolError(t,i,a),y=F,b.style.display="none",!1)};if(k.textContent.length>0){const A=k.textContent,H=k.dataset.filename;K("model-load","script-element");const G=s.createSource("script-element",H,A);s.fromNlogo(G,v,M.locale,!1,x,C,[],R)}else if(P.has("url")){const Q=P.get("url").trim();Q.startsWith("http")&&!B(Q)||(K("model-load","url",Q),s.fromURL(Q,v,M.locale,x,C,[],R))}else K("model-load","new-model"),N(u,"new","NewModel",!1);if(window.addEventListener("message",(function(e){if(null!==e.data&&"object"==typeof e.data)switch(e.data.type){case"nlw-load-model":K("model-load","file",e.data.path),N(e.data.nlogo,"disk",e.data.path,!1);break;case"nlw-open-new":K("model-load","new-model"),P.delete("url"),window.location.search=P.toString(),N(u,"new","NewModel",!1);break;case"nlw-revert-wip":{K("revert-work-in-progress"),q.revertWip();const e=q.getNlogoSource();N(e.nlogo,e.type,"url"===e.type?encodeURI(e.url):e.fileName,!1);break}case"nlw-undo-revert":{K("undo-revert"),q.undoRevert();const e=q.getNlogoSource();N(e.nlogo,e.type,"url"===e.type?encodeURI(e.url):e.fileName,!0);break}case"nlw-set-model-code":globalThis.session.widgetController.setCode(e.data.codeTabContents,e.data.autoRecompile);break;case"nlw-recompile":globalThis.session.recompile("system");break;case"nlw-recompile-procedures":{const t=globalThis.session.widgetController;t.pauseForevers();const o=e.data.autoRerunForevers?t.rerunForevers:()=>{};globalThis.session.recompileProcedures(e.data.proceduresCode,e.data.procedureNames,o);break}case"nlw-run-code":globalThis.session.run("console",e.data.code);break;case"nlw-update-model-state":globalThis.session.widgetController.setCode(e.data.codeTabContents);break;case"run-baby-behaviorspace":globalThis.session.asyncRunBabyBehaviorSpace(e.data.config,(function(t){e.source.postMessage({type:"baby-behaviorspace-results",id:e.data.id,data:t},"*")}));break;case"nlw-request-model-state":{const t=session.hnw.getModelState();e.source.postMessage({update:t,type:"nlw-state-update",sequenceNum:-1},"*");break}case"nlw-export-model":var t=globalThis.session.getNlogo();e.source.postMessage({type:"nlw-export-model-results",id:e.data.id,export:t},"*");break;case"nlw-request-view":{const t=session.widgetController.viewController.view.visibleCanvas.toDataURL("image/png");e.source.postMessage({base64:t,type:"nlw-view"},"*");break}case"nlw-subscribe-to-updates":session.hnw.subscribe(e.ports[0],"Standard sim");break;case"nlw-apply-update":{const{plotUpdates:t,viewUpdate:o}=e.data.update;void 0!==(o?.world&&o.world[0]?.ticks)&&(world.ticker.reset(),world.ticker.importTicks(o.world[0].ticks));const s=session.widgetController.viewController;s.applyUpdate(o),s.repaint();break}}})),U){var _="",I="";window.setInterval((function(){!globalThis.session||y.offsetWidth===_&&y.offsetHeight===I&&document.title==W(globalThis.session.modelTitle())||(document.title=W(globalThis.session.modelTitle()),_=y.offsetWidth,I=y.offsetHeight,parent.postMessage({width:_,height:I,title:document.title,type:"nlw-resize"},"*"))}),200)}}catch(J){d.showEarlyInitFailure(J)}
